<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3D Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/maximeo3D/3D-Viewer@refs/heads/master/styles.css">
    <script src="https://cdn.babylonjs.com/v7.54.2/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/v7.54.2/loaders/babylonjs.loaders.min.js"></script>
    <script>
        // Configure decoders for better mobile GLB compatibility
        if (window.BABYLON && BABYLON.DracoCompression) {
            // Use CDN Draco
            BABYLON.DracoCompression.Configuration = {
                decoder: {
                    wasmUrl: 'https://cdn.babylonjs.com/v7.54.2/draco_wasm_wrapper_gltf.js',
                    wasmBinaryUrl: 'https://cdn.babylonjs.com/v7.54.2/draco_decoder_gltf.wasm',
                    fallbackUrl: 'https://cdn.babylonjs.com/v7.54.2/draco_decoder_gltf.js'
                }
            };
        }
        if (window.BABYLON && BABYLON.MeshoptCompression) {
            BABYLON.MeshoptCompression.Configuration = {
                decoder: {
                    url: 'https://cdn.babylonjs.com/v7.54.2/meshopt_decoder.js'
                }
            };
        }
    </script>
    <script src="https://cdn.babylonjs.com/v7.54.2/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://cdn.babylonjs.com/v7.54.2/hdr/babylonjs.hdr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.10/dist/tweakpane.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/maximeo3D/3D-Viewer@refs/heads/master/tweakpaneManager.js"></script>
    <script>
        const showSidebar = true;
        const showTweakpane = true;
        window.showTweakpane = showTweakpane;
        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.style.setProperty('--sidebar-display', showSidebar ? 'flex' : 'none');
            window.dispatchEvent(new Event('resize'));
        });
        
        // Configuration par défaut
        const defaultConfig = {
            option: 'base',
            baseMaterial: 'Black'
        };
    </script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-content">
                <div class="category">
                    <h3>Rail Material</h3>
                    <div class="buttons">
                        <button class="sidebar-btn" id="material-black-btn">Black</button>
                        <button class="sidebar-btn" id="material-sand-btn">Sand</button>
                        <button class="sidebar-btn" id="material-kaki-btn">Kaki</button>
                    </div>
                </div>
                <div class="category">
                    <h3>Viewpoints</h3>
                    <div class="buttons">
                        <button class="sidebar-btn" id="viewpoint-1-btn">Viewpoint 1</button>
                        <button class="sidebar-btn" id="viewpoint-2-btn">Viewpoint 2</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="canvas-container">
            <canvas id="renderCanvas"></canvas>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/gh/maximeo3D/3D-Viewer@refs/heads/master/scene.js"></script>
    <script>
        // Connecter les boutons HTML au système de tags
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser dès que le TagManager est prêt (sans attendre 1s)
            const maxTries = 120; // ~2s à 60fps avant fallback léger
            let tries = 0;

            function initUI() {
                if (!window.tagManager) return false;
                
                // Boutons de matériau pour la base
                document.getElementById('material-black-btn').addEventListener('click', () => {
                    window.tagManager.applyMaterialConfig('grip', 'black');
                    updateButtonStates();
                });
                
                document.getElementById('material-sand-btn').addEventListener('click', () => {
                    window.tagManager.applyMaterialConfig('grip', 'sand');
                    updateButtonStates();
                });
                
                document.getElementById('material-kaki-btn').addEventListener('click', () => {
                    window.tagManager.applyMaterialConfig('grip', 'kaki');
                    updateButtonStates();
                });

                
                // Viewpoints buttons
                const vp1Btn = document.getElementById('viewpoint-1-btn');
                const vp2Btn = document.getElementById('viewpoint-2-btn');
                if (vp1Btn) vp1Btn.addEventListener('click', () => { 
                    if (window.gotoViewpoint) window.gotoViewpoint('Viewpoint1');
                    vp1Btn.classList.add('active');
                    vp2Btn && vp2Btn.classList.remove('active');
                });
                if (vp2Btn) vp2Btn.addEventListener('click', () => { 
                    if (window.gotoViewpoint) window.gotoViewpoint('Viewpoint2');
                    vp2Btn.classList.add('active');
                    vp1Btn && vp1Btn.classList.remove('active');
                });
                
                // Fonction pour obtenir la couleur active
                function getActiveMaterialColor() {
                    if (document.getElementById('material-black-btn').classList.contains('active')) return 'black';
                    if (document.getElementById('material-sand-btn').classList.contains('active')) return 'sand';
                    if (document.getElementById('material-kaki-btn').classList.contains('active')) return 'kaki';
                    return 'kaki'; // défaut
                }

                // Activer l'option base et un matériau par défaut
                ensureDefaultOption();
                ensureDefaultMaterial();
                // Activer Viewpoint 1 par défaut si présent
                const vp1 = document.getElementById('viewpoint-1-btn');
                if (vp1) vp1.classList.add('active');

                return true;
            }

            function waitForTagManager() {
                if (initUI()) return;
                if (tries++ < maxTries) {
                    requestAnimationFrame(waitForTagManager);
                } else {
                    setTimeout(waitForTagManager, 50); // fallback doux si toujours pas prêt
                }
            }

            waitForTagManager();
            
            function updateButtonStates() {
                if (!window.tagManager) return;
                
                const activeTags = window.tagManager.getActiveTags ? window.tagManager.getActiveTags() : {};
                
                // Reset all buttons (except viewpoint buttons)
                document.querySelectorAll('.sidebar-btn:not([id^="viewpoint-"])').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Activate material config buttons
                const materials = ['black', 'sand', 'kaki'];
                materials.forEach(material => {
                    const btn = document.getElementById(`material-${material}-btn`);
                    if (btn) {
                        btn.classList.remove('active');
                        const hasGripMat = activeTags.materials && activeTags.materials.grip === material;
                        if (hasGripMat) {
                            btn.classList.add('active');
                        }
                    }
                });
            }

            function ensureDefaultOption() {
                if (!window.tagManager) return;
                const activeTags = window.tagManager.getActiveTags ? window.tagManager.getActiveTags() : {};
                const tags = activeTags.activeTags || [];
                const hasBase = tags.includes('base');
                if (!hasBase) {
                    window.tagManager.setOption('base');
                }
                updateButtonStates();
            }

            function ensureDefaultMaterial() {
                if (!window.tagManager) return;
                const activeTags = window.tagManager.getActiveTags ? window.tagManager.getActiveTags() : {};
                const materials = activeTags.materials || {};
                const hasGripMat = !!materials.grip;
                if (!hasGripMat) {
                    window.tagManager.applyMaterialConfig('grip', 'black');
                }
                updateButtonStates();
            }

            // API publique pour contrôle externe
            window.gripViewerAPI = {
                // Changer la couleur
                setColor: function(color) {
                    if (!window.tagManager) {
                        console.warn('TagManager not ready yet');
                        return false;
                    }
                    const validColors = ['black', 'sand', 'kaki'];
                    if (!validColors.includes(color)) {
                        console.warn('Invalid color. Use: black, sand, or kaki');
                        return false;
                    }
                    window.tagManager.applyMaterialConfig('grip', color);
                    updateButtonStates();
                    return true;
                },
                
                // Aller à un viewpoint
                gotoViewpoint: function(viewpointNumber) {
                    if (window.gotoViewpoint) {
                        window.gotoViewpoint(`Viewpoint${viewpointNumber}`);
                        return true;
                    }
                    return false;
                },
                
                // Obtenir l'état actuel
                getState: function() {
                    if (!window.tagManager) return null;
                    return window.tagManager.getActiveTags();
                }
            };
            
            // Écouter les messages postMessage pour iframe
            window.addEventListener('message', function(event) {
                // Pour la sécurité, vérifiez l'origine en production
                // if (event.origin !== 'https://votre-site.com') return;
                
                const data = event.data;
                if (!data || !data.action) return;
                
                let result = { success: false };
                
                switch(data.action) {
                    case 'setColor':
                        result.success = window.gripViewerAPI.setColor(data.color);
                        break;
                    case 'setOption':
                        result.success = window.gripViewerAPI.setOption(data.option);
                        break;
                    case 'gotoViewpoint':
                        result.success = window.gripViewerAPI.gotoViewpoint(data.viewpoint);
                        break;
                    case 'getState':
                        result.success = true;
                        result.state = window.gripViewerAPI.getState();
                        break;
                }
                
                // Répondre au parent
                if (event.source) {
                    event.source.postMessage({
                        type: 'gripViewerResponse',
                        action: data.action,
                        result: result
                    }, event.origin);
                }
            });
        });
    </script>
</body>
</html>